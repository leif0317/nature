<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>氣體溶解度噴泉實驗 (雙變因探究)</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --bg-color: #f0f4f8;
            --panel-bg: #ffffff;
            --tag-color: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1 { margin: 0; font-size: 1.3rem; letter-spacing: 1px; }

        .author-badge {
            background-color: var(--tag-color);
            color: var(--primary-color);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #d4ac0d;
            transform: rotate(-2deg);
        }
        
        .controls-top {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select {
            padding: 5px 8px;
            border-radius: 4px;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            background: rgba(255,255,255,0.95);
            color: #333;
            font-weight: bold;
        }

        .monitor { 
            font-family: monospace; 
            background: rgba(0,0,0,0.3); 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.3);
            min-width: 120px;
            text-align: center;
        }

        .container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }

        .canvas-area {
            flex: 7;
            background: linear-gradient(to bottom, #eef2f3 0%, #ffffff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            border-radius: 8px;
            background: rgba(255,255,255,0.6);
        }

        .control-panel {
            flex: 3;
            max-width: 320px;
            background: var(--panel-bg);
            padding: 20px;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .step-box {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            background: #fafafa;
            transition: all 0.3s;
        }

        .step-box.active {
            border-color: #3498db;
            background: #f0f9ff;
            border-left: 4px solid #3498db;
        }

        .step-box.disabled { opacity: 0.5; pointer-events: none; }

        h3 { margin: 0 0 5px 0; font-size: 1rem; color: #333; }
        p { margin: 0 0 10px 0; font-size: 0.85rem; color: #666; }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: #3498db;
            color: white;
            transition: background 0.2s;
        }

        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }

        .btn-reset { background: #95a5a6; margin-top: auto; }
        .btn-reset:hover { background: #7f8c8d; }

        .info-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: white;
            margin-left: 5px;
        }

        @media (max-width: 900px) {
            .controls-top { display: none; }
            .control-panel { max-width: none; }
            .container { flex-direction: column; }
            .canvas-area { height: 60%; }
            .control-panel { height: 40%; }
        }
    </style>
</head>
<body>

<header>
    <div class="title-group">
        <h1>STEM 實驗室：噴泉實驗</h1>
        <span class="author-badge">小粘製作</span>
    </div>
    
    <div class="controls-top">
        <select id="gasSelect">
            <option value="NH3">氨氣 (鹼性)</option>
            <option value="HCL">氯化氫 (酸性)</option>
        </select>
        <select id="indSelect">
            <option value="PHEN">酚酞指示劑</option>
            <option value="LITMUS">石蕊試劑</option>
        </select>
        <div class="monitor" id="pressureUI">壓力: 1.00 atm</div>
    </div>
</header>

<div class="container">
    <div class="canvas-area">
        <canvas id="simCanvas" width="500" height="550"></canvas>
    </div>

    <div class="control-panel">
        <div style="display: flex; gap:10px; margin-bottom: 10px;" class="mobile-only">
             <select id="gasSelectMobile" style="flex:1; border:1px solid #ccc;">
                <option value="NH3">氨氣 (NH₃)</option>
                <option value="HCL">氯化氫 (HCl)</option>
            </select>
             <select id="indSelectMobile" style="flex:1; border:1px solid #ccc;">
                <option value="PHEN">酚酞</option>
                <option value="LITMUS">石蕊</option>
            </select>
        </div>

        <div id="step1" class="step-box active">
            <h3>步驟 1：啟動 (Priming)</h3>
            <p>擠壓滴管 (純水)。觀察氣體溶解於水中，但此時尚未發生指示劑反應。</p>
            <button id="btnStep1">擠壓滴管</button>
        </div>

        <div id="step2" class="step-box disabled">
            <h3>步驟 2：噴泉 (Fountain)</h3>
            <p>打開止水閥。指示劑溶液噴入後與氣體混合，觀察顏色變化。</p>
            <button id="btnStep2">打開止水閥</button>
        </div>

        <div class="step-box" style="border:none; background:none; padding:0;">
            <h3>實驗預測</h3>
            <ul style="padding-left: 20px; font-size: 0.85rem; color: #555;">
                <li id="predGas">氣體：氨氣 (鹼性)</li>
                <li id="predInd">指示劑：酚酞</li>
                <li id="predResult">預期結果：<span id="resultTag" style="background:#e91e63; color:white; padding:2px 5px; border-radius:3px;">變粉紅色</span></li>
            </ul>
        </div>

        <button id="btnReset" class="btn-reset">重置實驗</button>
    </div>
</div>

<script>
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
const pressureUI = document.getElementById('pressureUI');

// Controls
const gasSelect = document.getElementById('gasSelect');
const indSelect = document.getElementById('indSelect');
const gasSelectMobile = document.getElementById('gasSelectMobile');
const indSelectMobile = document.getElementById('indSelectMobile');

const btnStep1 = document.getElementById('btnStep1');
const btnStep2 = document.getElementById('btnStep2');
const btnReset = document.getElementById('btnReset');
const step1Box = document.getElementById('step1');
const step2Box = document.getElementById('step2');

// --- 化學資料庫 ---
const GAS_DATA = {
    NH3: { name: "氨氣 (NH₃)", type: 'base', color: 'rgba(100, 100, 100, 0.5)' },
    HCL: { name: "氯化氫 (HCl)", type: 'acid', color: 'rgba(100, 120, 100, 0.4)' }
};

const IND_DATA = {
    PHEN: { 
        name: "酚酞", 
        // 酚酞起始顏色：淺藍 (代表無色透明液體在視覺上的呈現)
        baseColor: 'rgba(135, 205, 255, 0.85)', 
        startColor: 'rgba(135, 205, 255, 0.85)', 
        getColor: (type) => type === 'base' ? 'rgba(255, 60, 140, 0.95)' : 'rgba(135, 205, 255, 0.85)' 
    },
    LITMUS: { 
        name: "石蕊", 
        // 石蕊起始顏色：紫色
        baseColor: 'rgba(140, 120, 200, 0.8)', 
        startColor: 'rgba(140, 120, 200, 0.8)',
        getColor: (type) => type === 'base' ? 'rgba(50, 50, 255, 0.9)' : 'rgba(255, 50, 50, 0.9)'
    }
};

// 顏色常數
const C = {
    glass: 'rgba(240, 248, 255, 0.4)',
    glassStroke: '#7f8c8d',
    stopper: '#5d4037',
    waterBlue: 'rgba(100, 180, 255, 0.6)' // 純水顏色 (滴管用)
};

// 當前設定
let currentSettings = {
    gas: GAS_DATA.NH3,
    ind: IND_DATA.PHEN,
    resultColor: 'rgba(255, 60, 140, 0.95)'
};

// 幾何參數
const CONFIG = {
    flask: { x: 250, y: 150, r: 100 },
    stopper: { y: 250, w: 40, h: 25 },
    tube: { tipY: 150, bottomY: 480, width: 6 },
    beaker: { x: 250, y: 440, w: 120, h: 90 },
    dropper: { x: 280, tipY: 240 }
};

// 狀態管理
let state = {
    step: 0, 
    pressure: 1.0,
    tubeHeight: 0,
    poolLevel: 0, 
    isSqueezing: false,
    maxPoolLevel: 0.45 
};

// 粒子
let particles = {
    gas: [],
    drops: [],
    fountain: []
};

// 初始化
function init() {
    syncSelectors();
    updateExperimentSettings();
    reset();
    animate();
}

function syncSelectors() {
    gasSelectMobile.value = gasSelect.value;
    indSelectMobile.value = indSelect.value;
}

function updateExperimentSettings() {
    const gasType = gasSelect.value;
    const indType = indSelect.value;
    
    currentSettings.gas = GAS_DATA[gasType];
    currentSettings.ind = IND_DATA[indType];
    currentSettings.resultColor = currentSettings.ind.getColor(currentSettings.gas.type);

    document.getElementById('predGas').textContent = `氣體：${currentSettings.gas.name} (${currentSettings.gas.type === 'base' ? '鹼性' : '酸性'})`;
    document.getElementById('predInd').textContent = `指示劑：${currentSettings.ind.name}`;
    
    const resTag = document.getElementById('resultTag');
    if (currentSettings.resultColor === currentSettings.ind.baseColor) {
        resTag.textContent = "無明顯變色";
        resTag.style.background = "#95a5a6";
    } else if (currentSettings.gas.type === 'base' && indType === 'PHEN') {
        resTag.textContent = "變粉紅色";
        resTag.style.background = "#e91e63";
    } else if (currentSettings.gas.type === 'base' && indType === 'LITMUS') {
        resTag.textContent = "變藍色";
        resTag.style.background = "#2980b9";
    } else if (currentSettings.gas.type === 'acid' && indType === 'LITMUS') {
        resTag.textContent = "變紅色";
        resTag.style.background = "#c0392b";
    }
}

function reset() {
    state = { 
        step: 0, 
        pressure: 1.0, 
        tubeHeight: 0, 
        poolLevel: 0, 
        isSqueezing: false,
        maxPoolLevel: 0.45 
    };
    particles = { gas: [], drops: [], fountain: [] };
    
    for(let i=0; i<300; i++) {
        let a = Math.random() * Math.PI * 2;
        let r = Math.sqrt(Math.random()) * (CONFIG.flask.r - 5);
        particles.gas.push({
            x: CONFIG.flask.x + r * Math.cos(a),
            y: CONFIG.flask.y + r * Math.sin(a),
            vx: (Math.random()-0.5),
            vy: (Math.random()-0.5)
        });
    }

    step1Box.classList.remove('disabled');
    step1Box.classList.add('active');
    step2Box.classList.add('disabled');
    step2Box.classList.remove('active');
    btnStep1.disabled = false;
    btnStep2.disabled = true;
    updatePressure();
}

function update() {
    // 1. 滴管水滴 (永遠是純水色)
    for (let i = particles.drops.length - 1; i >= 0; i--) {
        let p = particles.drops[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.3; 

        if (p.y > CONFIG.flask.y + CONFIG.flask.r - 10) { 
            particles.drops.splice(i, 1);
            state.poolLevel = Math.min(state.poolLevel + 0.01, 0.05); 
        }
    }

    // 2. 氣體溶解
    let poolSurfaceY = CONFIG.flask.y + CONFIG.flask.r - (state.poolLevel * CONFIG.flask.r * 2);
    let bottomCenterY = CONFIG.flask.y + CONFIG.flask.r;

    for (let i = particles.gas.length - 1; i >= 0; i--) {
        let p = particles.gas[i];
        
        if (state.poolLevel > 0) {
            let dx = CONFIG.flask.x - p.x;
            let dy = bottomCenterY - p.y;
            
            p.vx += dx * 0.015; 
            p.vy += dy * 0.02; 
            p.vx *= 0.92;
            p.vy *= 0.92;

            p.x += p.vx;
            p.y += p.vy;

            if (p.y > poolSurfaceY) {
                particles.gas.splice(i, 1);
                state.pressure = particles.gas.length / 300; 
                continue;
            }
        } else {
            p.x += p.vx; p.y += p.vy;
            let dx = p.x - CONFIG.flask.x;
            let dy = p.y - CONFIG.flask.y;
            if (Math.hypot(dx, dy) > CONFIG.flask.r - 2) {
                 p.vx *= -1; p.vy *= -1;
            }
        }
    }
    updatePressure();

    // 3. 噴泉上升
    if (state.step === 2) {
        let targetTubeH = (1.0 - state.pressure);
        if (state.tubeHeight < targetTubeH) state.tubeHeight += 0.02;

        let emissionRate = (state.poolLevel >= state.maxPoolLevel) ? 0 : 8;

        if ((state.tubeHeight > 0.6 || state.pressure < 0.5) && emissionRate > 0) { 
            state.tubeHeight = 1.0; 
            
            for(let k=0; k<emissionRate; k++) {
                particles.fountain.push({
                    x: CONFIG.flask.x,
                    y: CONFIG.tube.tipY,
                    vx: (Math.random()-0.5) * 7,
                    vy: - (5 + Math.random() * 7), 
                    life: 1.0,
                    // 噴出的水：保持燒杯內試劑的「原始顏色」
                    color: currentSettings.ind.startColor 
                });
            }
        }
    }

    // 4. 噴泉粒子物理
    for (let i = particles.fountain.length - 1; i >= 0; i--) {
        let p = particles.fountain[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.25; 

        let d = Math.hypot(p.x - CONFIG.flask.x, p.y - CONFIG.flask.y);
        if (d > CONFIG.flask.r - 2) {
            p.vx *= -0.6; p.vy *= -0.6;
            let angle = Math.atan2(p.y - CONFIG.flask.y, p.x - CONFIG.flask.x);
            p.x = CONFIG.flask.x + Math.cos(angle) * (CONFIG.flask.r - 3);
            p.y = CONFIG.flask.y + Math.sin(angle) * (CONFIG.flask.r - 3);
        }

        if (p.y > poolSurfaceY) {
            particles.fountain.splice(i, 1);
            if (state.poolLevel < state.maxPoolLevel) {
                state.poolLevel += 0.0003; 
            }
        }
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBeakerAndTubeBack();
    drawParticles();
    drawFlaskAndDropper();
}

function drawBeakerAndTubeBack() {
    let b = CONFIG.beaker;
    ctx.beginPath();
    ctx.rect(b.x - b.w/2, b.y, b.w, b.h);
    ctx.strokeStyle = "#999";
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // 燒杯水 (試劑起始色)
    ctx.fillStyle = currentSettings.ind.startColor;
    ctx.fillRect(b.x - b.w/2 + 2, b.y + 30, b.w - 4, b.h - 30);
    
    ctx.fillStyle = "#555";
    ctx.font = "12px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("指示劑溶液", b.x, b.y + b.h + 20);

    ctx.beginPath();
    ctx.moveTo(CONFIG.flask.x, CONFIG.tube.tipY);
    ctx.lineTo(CONFIG.flask.x - 3, CONFIG.tube.tipY + 15);
    ctx.lineTo(CONFIG.flask.x - 3, b.y + b.h - 10);
    ctx.lineTo(CONFIG.flask.x + 3, b.y + b.h - 10);
    ctx.lineTo(CONFIG.flask.x + 3, CONFIG.tube.tipY + 15);
    ctx.closePath();
    ctx.fillStyle = "rgba(255,255,255,0.5)";
    ctx.strokeStyle = "#aaa";
    ctx.lineWidth = 1;
    ctx.fill(); ctx.stroke();

    if (state.tubeHeight > 0) {
        let fullLen = (b.y + b.h - 10) - CONFIG.tube.tipY;
        let h = state.tubeHeight * fullLen;
        let topY = (b.y + b.h - 10) - h;
        ctx.fillStyle = currentSettings.ind.startColor;
        ctx.fillRect(CONFIG.flask.x - 2, topY, 4, h);
    }
}

function drawParticles() {
    // 氣體
    ctx.fillStyle = currentSettings.gas.color;
    particles.gas.forEach(p => {
        ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
    });

    // 滴管水滴 (固定為純水藍色)
    ctx.fillStyle = C.waterBlue;
    particles.drops.forEach(p => {
        ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
    });

    // 噴泉 (顏色由粒子帶有的屬性決定)
    particles.fountain.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.beginPath(); 
        ctx.arc(p.x, p.y, 1.5, 0, Math.PI*2); 
        ctx.fill();
    });

    // 底部積水
    if (state.poolLevel > 0) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(CONFIG.flask.x, CONFIG.flask.y, CONFIG.flask.r - 2, 0, Math.PI*2);
        ctx.clip();

        let h = state.poolLevel * CONFIG.flask.r * 2;
        let y = CONFIG.flask.y + CONFIG.flask.r - h;
        
        // 顏色邏輯：
        // 步驟 0 或 1：積水是滴管滴下去的純水 (C.waterBlue)
        // 步驟 2：開始噴入試劑並反應，轉為反應色 (currentSettings.resultColor)
        let poolColor = C.waterBlue;
        
        if (state.step === 2) {
            poolColor = currentSettings.resultColor;
        }

        ctx.fillStyle = poolColor;
        ctx.fillRect(CONFIG.flask.x - CONFIG.flask.r, y, CONFIG.flask.r*2, h);
        
        ctx.fillStyle = "rgba(255,255,255,0.3)";
        ctx.fillRect(CONFIG.flask.x - CONFIG.flask.r, y, CONFIG.flask.r*2, 2);
        ctx.restore();
    }
}

function drawFlaskAndDropper() {
    let sy = CONFIG.stopper.y;
    ctx.fillStyle = C.stopper;
    ctx.beginPath();
    ctx.moveTo(CONFIG.flask.x - 25, sy);
    ctx.lineTo(CONFIG.flask.x + 25, sy);
    ctx.lineTo(CONFIG.flask.x + 20, sy + 25);
    ctx.lineTo(CONFIG.flask.x - 20, sy + 25);
    ctx.fill();

    let dx = CONFIG.dropper.x;
    ctx.fillStyle = C.glass;
    ctx.strokeStyle = "#888";
    ctx.lineWidth = 1;
    
    ctx.beginPath();
    ctx.moveTo(dx - 3, CONFIG.dropper.tipY);
    ctx.lineTo(dx + 3, CONFIG.dropper.tipY);
    ctx.lineTo(dx + 3, sy + 35);
    ctx.lineTo(dx - 3, sy + 35);
    ctx.closePath();
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = "#e67e22";
    ctx.beginPath();
    let bulbW = state.isSqueezing ? 8 : 10;
    ctx.ellipse(dx, sy + 45, bulbW, 12, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.beginPath();
    ctx.arc(CONFIG.flask.x, CONFIG.flask.y, CONFIG.flask.r, 0, Math.PI*2);
    ctx.strokeStyle = C.glassStroke;
    ctx.lineWidth = 3;
    ctx.stroke();
    
    ctx.beginPath();
    ctx.arc(CONFIG.flask.x - 30, CONFIG.flask.y - 30, 20, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,0.25)";
    ctx.fill();
}

function onSettingChange() {
    updateExperimentSettings();
    reset();
}
gasSelect.addEventListener('change', () => { gasSelectMobile.value = gasSelect.value; onSettingChange(); });
indSelect.addEventListener('change', () => { indSelectMobile.value = indSelect.value; onSettingChange(); });
gasSelectMobile.addEventListener('change', () => { gasSelect.value = gasSelectMobile.value; onSettingChange(); });
indSelectMobile.addEventListener('change', () => { indSelect.value = indSelectMobile.value; onSettingChange(); });

btnStep1.addEventListener('click', () => {
    state.isSqueezing = true;
    setTimeout(() => state.isSqueezing = false, 200);

    let dx = CONFIG.dropper.x;
    let dy = CONFIG.dropper.tipY;
    
    let count = 0;
    let dropInt = setInterval(() => {
        if(count > 10) clearInterval(dropInt);
        particles.drops.push({
            x: dx,
            y: dy,
            vx: (Math.random()-0.5)*0.5,
            vy: 2
        });
        count++;
    }, 50);

    setTimeout(() => {
        if(state.poolLevel === 0) state.poolLevel = 0.04;
        state.step = 1; 
        
        btnStep2.disabled = false;
        step2Box.classList.remove('disabled');
        step2Box.classList.add('active');
        step1Box.classList.remove('active');
        step1Box.classList.add('disabled');
    }, 1500);
    
    btnStep1.disabled = true;
});

btnStep2.addEventListener('click', () => {
    state.step = 2;
    if (state.pressure > 0.3) state.pressure = 0.1;
    btnStep2.disabled = true;
    step2Box.classList.remove('active');
    step2Box.classList.add('disabled');
});

btnReset.addEventListener('click', reset);

function updatePressure() {
    pressureUI.innerText = `壓力: ${state.pressure.toFixed(2)} atm`;
    let redness = Math.floor((1 - state.pressure) * 150);
    pressureUI.style.backgroundColor = `rgba(${redness}, 50, 50, 0.5)`;
}

function animate() {
    update();
    draw();
    requestAnimationFrame(animate);
}

init();

</script>
</body>
</html>