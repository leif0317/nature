<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿç‰©ç´°èƒå¯¦é©—å®¤ (å´é‚Šæ¬„ç‰ˆ)</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        /* æ¨™é¡Œèˆ‡ç½²å */
        .header-box {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        h1 { color: #1e293b; margin: 0; font-size: 2rem; }

        .signature {
            background: linear-gradient(135deg, #6366f1, #ec4899);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            border: 2px solid white;
            transform: rotate(-3deg);
        }

        /* é ‚éƒ¨æ¨¡å¼åˆ‡æ›éˆ• */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        button.mode-btn {
            padding: 10px 25px;
            font-size: 16px;
            border: 2px solid #cbd5e1;
            background: white;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            color: #64748b;
        }
        button.mode-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        button.active-mitosis { background-color: #22c55e; color: white; border-color: #22c55e; }
        button.active-meiosis { background-color: #a855f7; color: white; border-color: #a855f7; }
        button.active-cloning { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        /* === æ ¸å¿ƒä½ˆå±€å®¹å™¨ (Flexbox: å·¦åœ–å³æ–‡) === */
        .main-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start; /* é ‚éƒ¨å°é½Š */
            justify-content: center;
        }

        /* å·¦å´ï¼šç•«å¸ƒ */
        #canvas-wrapper {
            position: relative;
            width: 900px;
            height: 600px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 4px solid #475569;
            overflow: hidden;
            flex-shrink: 0; /* é˜²æ­¢ç¸®å° */
        }

        /* å³å´ï¼šè³‡è¨Šé¢æ¿ */
        #info-panel {
            width: 280px;
            height: 600px; /* èˆ‡ç•«å¸ƒç­‰é«˜ */
            background: white;
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            justify-content: space-between; /* å…§å®¹æ’é–‹ï¼ŒæŒ‰éˆ•ç½®åº• */
            box-sizing: border-box;
        }

        /* æ­¥é©ŸæŒ‡ç¤º (åœ“è§’æ¡†) */
        .step-indicator-box {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        #step-badge-text { font-size: 1.2rem; font-weight: 800; color: #334155; display: block; margin-bottom: 5px; }
        #step-count { color: #94a3b8; font-family: monospace; font-weight: bold; }

        /* èªªæ˜æ–‡å­—å€ */
        #desc-text {
            font-size: 1.15rem;
            color: #475569;
            line-height: 1.6;
            flex-grow: 1; /* ä½”æ“šä¸­é–“æ‰€æœ‰ç©ºé–“ */
            display: flex;
            align-items: center; /* æ–‡å­—å‚ç›´å±…ä¸­ */
            text-align: justify; /* å·¦å³å°é½Š */
        }

        /* åº•éƒ¨å°èˆªæŒ‰éˆ•ç¾¤çµ„ */
        .nav-group {
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ—æŒ‰éˆ• */
            gap: 10px;
            margin-top: 20px;
        }

        .nav-row {
            display: flex;
            gap: 10px;
        }

        button.nav-btn {
            padding: 15px;
            font-size: 1rem;
            border-radius: 12px;
            border: none;
            background-color: #f1f5f9;
            color: #475569;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1; /* å‡åˆ†å¯¬åº¦ */
        }
        button.nav-btn:hover { background-color: #e2e8f0; }
        button.nav-btn:active { transform: scale(0.98); }
        
        button.btn-next { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); }
        button.btn-next:hover { background-color: #2563eb; transform: translateY(-1px); }
        
        button.nav-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; background: #f1f5f9; color: #cbd5e1; }

        /* SVG å‹•ç•«é¡åˆ¥ */
        .anim-target { transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>

    <div class="header-box">
        <h1>ğŸ§¬ ç”Ÿç‰©ç´°èƒå¯¦é©—å®¤</h1>
        <div class="signature">å°ç²˜è£½ä½œ</div>
    </div>

    <div class="controls">
        <button id="btn-mitosis" class="mode-btn" onclick="setMode('mitosis')">ç´°èƒåˆ†è£‚</button>
        <button id="btn-meiosis" class="mode-btn" onclick="setMode('meiosis')">æ¸›æ•¸åˆ†è£‚</button>
        <button id="btn-cloning" class="mode-btn" onclick="setMode('cloning')">è¤‡è£½ç¾Š Dolly</button>
    </div>

    <div class="main-layout">
        
        <div id="canvas-wrapper">
            <svg id="main-stage" width="900" height="600" viewBox="0 0 900 600">
                <defs>
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <circle cx="2" cy="2" r="1.5" fill="#e2e8f0" />
                    </pattern>
                    <g id="sheep-body-def">
                        <ellipse cx="0" cy="10" rx="35" ry="25" fill="#f1f5f9" stroke="#94a3b8" stroke-width="2"/>
                        <line x1="-20" y1="25" x2="-20" y2="45" stroke="#64748b" stroke-width="4" stroke-linecap="round"/>
                        <line x1="20" y1="25" x2="20" y2="45" stroke="#64748b" stroke-width="4" stroke-linecap="round"/>
                    </g>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />

                <g id="layer-cells"></g>
                <g id="layer-chromosomes"></g>
                <g id="layer-cloning"></g>
            </svg>
        </div>

        <div id="info-panel">
            <div class="step-indicator-box">
                <span id="step-badge-text">Step 0</span>
                <span id="step-count">0 / 0</span>
            </div>

            <div id="desc-text">
                è«‹é¸æ“‡ä¸Šæ–¹æ¨¡å¼é–‹å§‹å¯¦é©—...
            </div>
            
            <div class="nav-group">
                <button id="btn-next" class="nav-btn btn-next" onclick="changeStep(1)">ä¸‹ä¸€æ­¥ â–¶</button>
                <button id="btn-prev" class="nav-btn" onclick="changeStep(-1)">â—€ ä¸Šä¸€æ­¥</button>
            </div>
        </div>

    </div>

<script>
    // --- ç³»çµ±ç‹€æ…‹ ---
    const state = {
        mode: 'mitosis',
        step: 0,
        maxStep: 4
    };

    // --- åº§æ¨™å¸¸æ•¸ ---
    const POS = {
        CENTER: { x: 450, y: 300 },
        LEFT:   { x: 230, y: 300 },
        RIGHT:  { x: 670, y: 300 },
        Q1: { x: 230, y: 150 }, Q2: { x: 230, y: 450 },
        Q3: { x: 670, y: 150 }, Q4: { x: 670, y: 450 }
    };

    // --- è³‡æ–™å®šç¾© ---
    const chromosomeIds = [
        { id: 'LD',  type: 'L', isCopy: false, color: '#3b82f6', border: '#1d4ed8' }, 
        { id: 'LDc', type: 'L', isCopy: true,  color: '#93c5fd', border: '#1d4ed8' }, 
        { id: 'SD',  type: 'S', isCopy: false, color: '#3b82f6', border: '#1d4ed8' }, 
        { id: 'SDc', type: 'S', isCopy: true,  color: '#93c5fd', border: '#1d4ed8' }, 
        { id: 'LM',  type: 'L', isCopy: false, color: '#ec4899', border: '#be185d' }, 
        { id: 'LMc', type: 'L', isCopy: true,  color: '#f9a8d4', border: '#be185d' }, 
        { id: 'SM',  type: 'S', isCopy: false, color: '#ec4899', border: '#be185d' }, 
        { id: 'SMc', type: 'S', isCopy: true,  color: '#f9a8d4', border: '#be185d' }
    ];
    const cellIds = ['c1', 'c2', 'c3', 'c4'];

    const cloneIds = [
        {id: 'sheepA_body', type: 'use', href:'#sheep-body-def'},
        {id: 'sheepA_head', type: 'ellipse', rx: 12, ry: 18, fill: '#1e293b', cx: -35, cy: 0}, 
        {id: 'sheepA_label', type: 'text', text: 'Aç¾Š(é»‘é¢/ä¾›æ ¸)', y: 60, fill:'#334155'},
        
        {id: 'sheepB_body', type: 'use', href:'#sheep-body-def'},
        {id: 'sheepB_head', type: 'ellipse', rx: 12, ry: 18, fill: '#fff', stroke:'#94a3b8', strokeW:2, cx: -35, cy: 0},
        {id: 'sheepB_label', type: 'text', text: 'Bç¾Š(ç™½é¢/ä¾›åµ)', y: 60, fill:'#334155'},
        
        {id: 'sheepC_body', type: 'use', href:'#sheep-body-def'},
        {id: 'sheepC_head', type: 'ellipse', rx: 12, ry: 18, fill: '#fff', stroke:'#94a3b8', strokeW:2, cx: -35, cy: 0}, 
        {id: 'sheepC_label', type: 'text', text: 'Cç¾Š(ä»£ç†å­•æ¯)', y: 60, fill:'#334155'},

        {id: 'cellA', type: 'circle', r: 40, fill: '#bfdbfe', stroke: '#3b82f6'}, 
        {id: 'cellB', type: 'circle', r: 40, fill: '#fbcfe8', stroke: '#ec4899'}, 
        
        {id: 'nucA',  type: 'circle', r: 15, fill: '#1e293b', text: '2N'}, // é»‘æ ¸
        {id: 'nucB',  type: 'circle', r: 15, fill: '#be185d', text: 'N'},  // ç²‰æ ¸
        {id: 'nucRemove', type: 'text', text: 'âŒ', size: 20},

        {id: 'emb1', type: 'circle', r: 15, fill: '#bfdbfe', stroke: '#3b82f6'},
        {id: 'emb2', type: 'circle', r: 15, fill: '#bfdbfe', stroke: '#3b82f6'},
        {id: 'emb3', type: 'circle', r: 15, fill: '#bfdbfe', stroke: '#3b82f6'},
        {id: 'emb4', type: 'circle', r: 15, fill: '#bfdbfe', stroke: '#3b82f6'},
        {id: 'emb5', type: 'circle', r: 15, fill: '#bfdbfe', stroke: '#3b82f6'},

        {id: 'bolt',  type: 'text', text: 'âš¡', size: 60},
        
        {id: 'baby_body', type: 'use', href:'#sheep-body-def'},
        {id: 'baby_head', type: 'ellipse', rx: 10, ry: 15, fill: '#1e293b', cx: -30, cy: 0},
        {id: 'baby_label', type: 'text', text: 'Dolly (é»‘é¢)', y: 50, fill:'#1e293b', weight:'bold'}
    ];

    // --- DOM åˆå§‹åŒ– ---
    window.onload = function() {
        const cellLayer = document.getElementById('layer-cells');
        const chromLayer = document.getElementById('layer-chromosomes');
        const cloneLayer = document.getElementById('layer-cloning');

        cellIds.forEach(id => {
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("id", id);
            c.setAttribute("class", "anim-target");
            c.setAttribute("r", "0");
            c.setAttribute("fill", "rgba(255,255,255,0.5)");
            c.setAttribute("stroke-width", "4");
            cellLayer.appendChild(c);
        });

        chromosomeIds.forEach(data => {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("id", data.id);
            g.setAttribute("class", "anim-target");

            const w = 24;
            const h = data.type === 'L' ? 120 : 70;
            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("x", -w/2);
            rect.setAttribute("y", -h/2);
            rect.setAttribute("width", w);
            rect.setAttribute("height", h);
            rect.setAttribute("rx", "12");
            rect.setAttribute("fill", data.color);
            rect.setAttribute("stroke", data.border);
            rect.setAttribute("stroke-width", "3");
            if (data.isCopy) {
                rect.setAttribute("stroke-dasharray", "6,4");
                rect.setAttribute("fill-opacity", "0.8");
            }
            const cen = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            cen.setAttribute("r", "8");
            cen.setAttribute("fill", "#fbbf24");
            cen.setAttribute("stroke", "#b45309");
            cen.setAttribute("stroke-width", "2");
            g.appendChild(rect);
            g.appendChild(cen);
            chromLayer.appendChild(g);
        });

        cloneIds.forEach(data => {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("id", data.id);
            g.setAttribute("class", "anim-target");
            g.setAttribute("opacity", "0");

            if (data.type === 'use') {
                const use = document.createElementNS("http://www.w3.org/2000/svg", "use");
                use.setAttribute("href", data.href);
                g.appendChild(use);
            } else if (data.type === 'ellipse') {
                const el = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                el.setAttribute("rx", data.rx);
                el.setAttribute("ry", data.ry);
                el.setAttribute("fill", data.fill);
                el.setAttribute("cx", data.cx || 0);
                el.setAttribute("cy", data.cy || 0);
                if(data.stroke) {
                    el.setAttribute("stroke", data.stroke);
                    el.setAttribute("stroke-width", data.strokeW);
                }
                g.appendChild(el);
            } else if (data.type === 'text') {
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.textContent = data.text;
                txt.setAttribute("font-size", data.size || "16");
                txt.setAttribute("text-anchor", "middle");
                txt.setAttribute("fill", data.fill || "black");
                if(data.y) txt.setAttribute("y", data.y);
                if(data.weight) txt.setAttribute("font-weight", data.weight);
                g.appendChild(txt);
            } else if (data.type === 'circle') {
                const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c.setAttribute("r", data.r);
                c.setAttribute("fill", data.fill);
                if(data.stroke) {
                    c.setAttribute("stroke", data.stroke);
                    c.setAttribute("stroke-width", "3");
                }
                g.appendChild(c);
                if (data.text) {
                    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    t.textContent = data.text;
                    t.setAttribute("fill", "white");
                    t.setAttribute("font-size", "12");
                    t.setAttribute("text-anchor", "middle");
                    t.setAttribute("dy", ".35em");
                    g.appendChild(t);
                }
            }
            cloneLayer.appendChild(g);
        });

        setMode('mitosis');
    };

    // --- å ´æ™¯æ›´æ–°é‚è¼¯ ---
    function updateScene() {
        const s = state.step;
        const m = state.mode;

        let tCells = []; 
        let tChroms = {}; 
        let tClone = {}; 

        if (m !== 'cloning') {
            cloneIds.forEach(obj => tClone[obj.id] = {x:450, y:300, s:0, o:0});
        } else {
            cellIds.forEach(id => tCells.push({id:id, x:450, y:300, r:0, o:0}));
            chromosomeIds.forEach(c => tChroms[c.id] = {x:450, y:300, r:0, o:0});
        }

        // === Mitosis ===
        if (m === 'mitosis') {
            state.maxStep = 4;
            const color = "#22c55e"; 

            if (s === 0) { // é–“æœŸ
                tCells = [{id:'c1', x:POS.CENTER.x, y:POS.CENTER.y, r:280, o:1}];
                tChroms = {
                    'LD': {x:380, y:200, r:15, o:1}, 'LDc': {x:380, y:200, r:15, o:0},
                    'LM': {x:520, y:200, r:-15, o:1}, 'LMc': {x:520, y:200, r:-15, o:0},
                    'SD': {x:380, y:400, r:-10, o:1}, 'SDc': {x:380, y:400, r:-10, o:0},
                    'SM': {x:520, y:400, r:10, o:1}, 'SMc': {x:520, y:400, r:10, o:0}
                };
            }
            else if (s === 1) { // è¤‡è£½
                tCells = [{id:'c1', x:POS.CENTER.x, y:POS.CENTER.y, r:280, o:1}];
                tChroms = {
                    'LD': {x:380, y:200, r:-20, o:1}, 'LDc': {x:380, y:200, r:20, o:1},
                    'LM': {x:520, y:200, r:-20, o:1}, 'LMc': {x:520, y:200, r:20, o:1},
                    'SD': {x:380, y:400, r:-20, o:1}, 'SDc': {x:380, y:400, r:20, o:1},
                    'SM': {x:520, y:400, r:-20, o:1}, 'SMc': {x:520, y:400, r:20, o:1}
                };
            }
            else if (s === 2) { // æ’åˆ—
                tCells = [{id:'c1', x:POS.CENTER.x, y:POS.CENTER.y, r:280, o:1}];
                tChroms = {
                    'LD': {x:450, y:120, r:70, o:1}, 'LDc': {x:450, y:120, r:110, o:1},
                    'LM': {x:450, y:240, r:70, o:1}, 'LMc': {x:450, y:240, r:110, o:1},
                    'SD': {x:450, y:360, r:70, o:1}, 'SDc': {x:450, y:360, r:110, o:1},
                    'SM': {x:450, y:480, r:70, o:1}, 'SMc': {x:450, y:480, r:110, o:1}
                };
            }
            else if (s === 3) { // åˆ†é›¢
                tCells = [{id:'c1', x:POS.CENTER.x, y:POS.CENTER.y, r:320, o:0.3}];
                const lx = POS.LEFT.x - 50, rx = POS.RIGHT.x + 50;
                tChroms = {
                    'LD': {x:lx, y:120, r:90, o:1}, 'LDc': {x:rx, y:120, r:-90, o:1},
                    'LM': {x:lx, y:240, r:90, o:1}, 'LMc': {x:rx, y:240, r:-90, o:1},
                    'SD': {x:lx, y:360, r:90, o:1}, 'SDc': {x:rx, y:360, r:-90, o:1},
                    'SM': {x:lx, y:480, r:90, o:1}, 'SMc': {x:rx, y:480, r:-90, o:1}
                };
            }
            else if (s === 4) { // å…©ç´°èƒ
                tCells = [
                    {id:'c1', x:POS.LEFT.x, y:POS.LEFT.y, r:200, o:1},
                    {id:'c2', x:POS.RIGHT.x, y:POS.RIGHT.y, r:200, o:1}
                ];
                tChroms = {
                    'LD': {x:200, y:250, r:15, o:1}, 'LDc': {x:650, y:250, r:15, o:1},
                    'LM': {x:250, y:350, r:-15, o:1}, 'LMc': {x:700, y:350, r:-15, o:1},
                    'SD': {x:200, y:350, r:10, o:1}, 'SDc': {x:650, y:350, r:10, o:1},
                    'SM': {x:250, y:250, r:-10, o:1}, 'SMc': {x:700, y:250, r:-10, o:1}
                };
            }
            applyAnim(tCells, tChroms, color);
        }

        // === Meiosis ===
        else if (m === 'meiosis') {
            state.maxStep = 6;
            const color = "#a855f7"; 

            if (s <= 1) { 
                tCells = [{id:'c1', x:POS.CENTER.x, y:POS.CENTER.y, r:280, o:1}];
                const deg = s===0 ? 0 : 20;
                const op = s===0 ? 0 : 1;
                tChroms = {
                    'LD': {x:380, y:200, r:-deg, o:1}, 'LDc': {x:380, y:200, r:deg, o:op},
                    'SD': {x:380, y:400, r:-deg, o:1}, 'SDc': {x:380, y:400, r:deg, o:op},
                    'LM': {x:520, y:200, r:-deg, o:1}, 'LMc': {x:520, y:200, r:deg, o:op},
                    'SM': {x:520, y:400, r:-deg, o:1}, 'SMc': {x:520, y:400, r:deg, o:op}
                };
                if(s===0) { tChroms['LD'].r=15; tChroms['SD'].r=-10; tChroms['LM'].r=-15; tChroms['SM'].r=10; }
            }
            else if (s === 2) { 
                tCells = [{id:'c1', x:POS.CENTER.x, y:POS.CENTER.y, r:280, o:1}];
                tChroms = {
                    'LD': {x:400, y:180, r:-20, o:1}, 'LDc': {x:400, y:180, r:20, o:1},
                    'LM': {x:500, y:180, r:-20, o:1}, 'LMc': {x:500, y:180, r:20, o:1},
                    'SD': {x:400, y:420, r:-20, o:1}, 'SDc': {x:400, y:420, r:20, o:1},
                    'SM': {x:500, y:420, r:-20, o:1}, 'SMc': {x:500, y:420, r:20, o:1}
                };
            }
            else if (s === 3) { 
                tCells = [{id:'c1', x:POS.CENTER.x, y:POS.CENTER.y, r:320, o:0.3}];
                const lx = POS.LEFT.x, rx = POS.RIGHT.x;
                tChroms = {
                    'LD': {x:lx, y:180, r:-20, o:1}, 'LDc': {x:lx, y:180, r:20, o:1},
                    'LM': {x:rx, y:180, r:-20, o:1}, 'LMc': {x:rx, y:180, r:20, o:1},
                    'SD': {x:lx, y:420, r:-20, o:1}, 'SDc': {x:lx, y:420, r:20, o:1},
                    'SM': {x:rx, y:420, r:-20, o:1}, 'SMc': {x:rx, y:420, r:20, o:1}
                };
            }
            else if (s === 4) { 
                tCells = [ {id:'c1', x:POS.LEFT.x, y:POS.LEFT.y, r:200, o:1}, {id:'c2', x:POS.RIGHT.x, y:POS.RIGHT.y, r:200, o:1} ];
                const lx = POS.LEFT.x, rx = POS.RIGHT.x;
                tChroms = {
                    'LD': {x:lx, y:180, r:70, o:1}, 'LDc': {x:lx, y:180, r:110, o:1},
                    'SD': {x:lx, y:420, r:70, o:1}, 'SDc': {x:lx, y:420, r:110, o:1},
                    'LM': {x:rx, y:180, r:70, o:1}, 'LMc': {x:rx, y:180, r:110, o:1},
                    'SM': {x:rx, y:420, r:70, o:1}, 'SMc': {x:rx, y:420, r:110, o:1}
                };
            }
            else if (s === 5) { 
                tCells = [ {id:'c1', x:POS.LEFT.x, y:POS.LEFT.y, r:200, o:0.3}, {id:'c2', x:POS.RIGHT.x, y:POS.RIGHT.y, r:200, o:0.3} ];
                const lxL = POS.LEFT.x-35, lxS = POS.LEFT.x+35;
                const rxL = POS.RIGHT.x-35, rxS = POS.RIGHT.x+35;
                tChroms = {
                    'LD': {x:lxL, y:100, r:0, o:1}, 'SDc': {x:lxS, y:100, r:0, o:1},
                    'LDc': {x:lxL, y:500, r:0, o:1}, 'SD': {x:lxS, y:500, r:0, o:1},
                    'LM': {x:rxL, y:100, r:0, o:1}, 'SM': {x:rxS, y:100, r:0, o:1},
                    'LMc': {x:rxL, y:500, r:0, o:1}, 'SMc': {x:rxS, y:500, r:0, o:1}
                };
            }
            else if (s === 6) { 
                const q1 = POS.Q1, q2 = POS.Q2, q3 = POS.Q3, q4 = POS.Q4;
                tCells = [
                    {id:'c1', x:q1.x, y:q1.y, r:130, o:1}, {id:'c2', x:q2.x, y:q2.y, r:130, o:1},
                    {id:'c3', x:q3.x, y:q3.y, r:130, o:1}, {id:'c4', x:q4.x, y:q4.y, r:130, o:1}
                ];
                tChroms = {
                    'LD': {x:q1.x-15, y:q1.y, r:15, o:1}, 'SDc': {x:q1.x+15, y:q1.y, r:-10, o:1},
                    'LDc': {x:q2.x-15, y:q2.y, r:15, o:1}, 'SD': {x:q2.x+15, y:q2.y, r:-10, o:1},
                    'LM': {x:q3.x-15, y:q3.y, r:15, o:1}, 'SM': {x:q3.x+15, y:q3.y, r:-10, o:1},
                    'LMc': {x:q4.x-15, y:q4.y, r:15, o:1}, 'SMc': {x:q4.x+15, y:q4.y, r:-10, o:1}
                };
            }
            applyAnim(tCells, tChroms, color);
        }

        // === Cloning ===
        else if (m === 'cloning') {
            state.maxStep = 6;
            tCells = []; tChroms = {};
            applyAnim(tCells, chromosomeIds.map(c=>{return{id:c.id, o:0}}).reduce((acc,cur)=>{acc[cur.id]=cur; return acc;}, {}), "transparent");

            const allSheep = ['sheepA_body','sheepA_head','sheepA_label','sheepB_body','sheepB_head','sheepB_label','sheepC_body','sheepC_head','sheepC_label','baby_body','baby_head','baby_label'];
            const resetClone = {};
            allSheep.concat(['cellA','cellB','nucA','nucB','nucRemove','emb1','emb2','emb3','emb4','emb5','bolt']).forEach(id => {
                resetClone[id] = {x:450, y:300, s:0, o:0};
            });

            if (s === 0) {
                tClone = { ...resetClone,
                    'sheepA_body': {x:200, y:200, s:1, o:1}, 'sheepA_head': {x:200, y:200, s:1, o:1}, 'sheepA_label': {x:200, y:200, s:1, o:1},
                    'sheepB_body': {x:700, y:200, s:1, o:1}, 'sheepB_head': {x:700, y:200, s:1, o:1}, 'sheepB_label': {x:700, y:200, s:1, o:1},
                    'sheepC_body': {x:450, y:500, s:0.8, o:0.5}, 'sheepC_head': {x:450, y:500, s:0.8, o:0.5}, 'sheepC_label': {x:450, y:500, s:0.8, o:0.5},
                };
            }
            else if (s === 1) { 
                tClone = { ...resetClone,
                    'sheepA_body': {x:200, y:100, s:0.8, o:0.5}, 'sheepA_head': {x:200, y:100, s:0.8, o:0.5},
                    'sheepB_body': {x:700, y:100, s:0.8, o:0.5}, 'sheepB_head': {x:700, y:100, s:0.8, o:0.5},
                    'cellA': {x:300, y:250, s:1, o:1}, 'cellB': {x:600, y:250, s:1, o:1},
                    'nucA': {x:300, y:250, s:1, o:1}, 'nucB': {x:600, y:250, s:1, o:1},
                };
            }
            else if (s === 2) { 
                tClone = { ...resetClone,
                    'sheepA_body': {x:200, y:100, s:0.8, o:0.5}, 'sheepA_head': {x:200, y:100, s:0.8, o:0.5},
                    'sheepB_body': {x:700, y:100, s:0.8, o:0.5}, 'sheepB_head': {x:700, y:100, s:0.8, o:0.5},
                    'cellA': {x:300, y:250, s:1, o:1}, 'cellB': {x:600, y:250, s:1, o:1},
                    'nucA': {x:300, y:250, s:1, o:1}, 'nucB': {x:600, y:150, s:0.5, o:0.2}, 'nucRemove': {x:600, y:150, s:1, o:1}
                };
            }
            else if (s === 3) { 
                tClone = { ...resetClone,
                    'sheepA_body': {x:200, y:100, s:0.8, o:0.3}, 'sheepA_head': {x:200, y:100, s:0.8, o:0.3},
                    'sheepB_body': {x:700, y:100, s:0.8, o:0.3}, 'sheepB_head': {x:700, y:100, s:0.8, o:0.3},
                    'cellB': {x:450, y:250, s:1.2, o:1}, 'nucA': {x:450, y:250, s:1, o:1}, 'bolt': {x:450, y:200, s:1, o:1}
                };
            }
            else if (s === 4) { 
                tClone = { ...resetClone,
                    'sheepA_body': {x:200, y:100, s:0.8, o:0.1}, 'sheepA_head': {x:200, y:100, s:0.8, o:0.1},
                    'sheepB_body': {x:700, y:100, s:0.8, o:0.1}, 'sheepB_head': {x:700, y:100, s:0.8, o:0.1},
                    'sheepC_body': {x:450, y:500, s:0.8, o:0.5}, 'sheepC_head': {x:450, y:500, s:0.8, o:0.5},
                    'emb1': {x:450, y:250, s:1, o:1}, 'emb2': {x:430, y:240, s:1, o:1}, 'emb3': {x:470, y:240, s:1, o:1},
                    'emb4': {x:430, y:260, s:1, o:1}, 'emb5': {x:470, y:260, s:1, o:1}
                };
            }
            else if (s === 5) { 
                tClone = { ...resetClone,
                    'sheepC_body': {x:450, y:300, s:1.5, o:1}, 'sheepC_head': {x:450, y:300, s:1.5, o:1}, 'sheepC_label': {x:450, y:300, s:1.5, o:1},
                };
            }
            else if (s === 6) { 
                tClone = { ...resetClone,
                    'sheepA_body': {x:200, y:200, s:1, o:1}, 'sheepA_head': {x:200, y:200, s:1, o:1}, 'sheepA_label': {x:200, y:200, s:1, o:1},
                    'sheepB_body': {x:700, y:100, s:0.8, o:0.1}, 'sheepB_head': {x:700, y:100, s:0.8, o:0.1},
                    'baby_body': {x:550, y:350, s:1.5, o:1}, 'baby_head': {x:550, y:350, s:1.5, o:1}, 'baby_label': {x:550, y:350, s:1.5, o:1}
                };
            }
            applyCloneAnim(tClone);
        }
    }

    function applyAnim(tCells, tChroms, color) {
        cellIds.forEach(id => {
            const el = document.getElementById(id);
            const t = tCells.find(c => c.id === id);
            if (t) {
                el.setAttribute("transform", `translate(0, 0)`);
                el.setAttribute("cx", t.x); el.setAttribute("cy", t.y); el.setAttribute("r", t.r);
                el.setAttribute("stroke", color); el.setAttribute("fill-opacity", t.o * 0.1); el.setAttribute("stroke-opacity", t.o);
            } else { el.setAttribute("r", "0"); }
        });
        for (const [id, t] of Object.entries(tChroms)) {
            const el = document.getElementById(id);
            if (el) {
                el.setAttribute("transform", `translate(${t.x}, ${t.y}) rotate(${t.r})`);
                el.setAttribute("opacity", t.o);
            }
        }
    }

    function applyCloneAnim(tClone) {
        for (const [id, t] of Object.entries(tClone)) {
            const el = document.getElementById(id);
            if (el) {
                el.setAttribute("transform", `translate(${t.x}, ${t.y}) scale(${t.s})`);
                el.setAttribute("opacity", t.o);
            }
        }
    }

    function updateUI() {
        document.getElementById('step-badge-text').textContent = `Step ${state.step}`;
        document.getElementById('step-count').textContent = `${state.step} / ${state.maxStep}`;
        
        document.getElementById('btn-prev').disabled = state.step === 0;
        document.getElementById('btn-next').disabled = state.step === state.maxStep;
        
        const bMit = document.getElementById('btn-mitosis');
        const bMei = document.getElementById('btn-meiosis');
        const bClo = document.getElementById('btn-cloning');
        bMit.className = 'mode-btn'; bMei.className = 'mode-btn'; bClo.className = 'mode-btn';

        const info = document.getElementById('desc-text');
        
        if (state.mode === 'mitosis') {
            bMit.className += ' active-mitosis';
            const txt = [
                "é–“æœŸï¼šæŸ“è‰²é«”æœªè¤‡è£½ï¼Œæ•£å¸ƒåœ¨ç´°èƒæ ¸ä¸­ã€‚",
                "è¤‡è£½ï¼šæŸ“è‰²é«”è¤‡è£½ï¼Œå…©æ¢å§Šå¦¹æŸ“è‰²åˆ†é«”å½¢æˆ X å‹ã€‚",
                "æ’åˆ—ï¼šX å‹æŸ“è‰²é«”å‚ç›´æ’åˆ—åœ¨ç´°èƒä¸­å¤®ã€‚",
                "åˆ†é›¢ï¼šX å‹å¾ä¸­é–“æ–·é–‹ï¼Œå§Šå¦¹åˆ†é«”åˆ†åˆ¥ç§»å‘å·¦å³å…©ç«¯ã€‚",
                "å®Œæˆï¼šç´°èƒè†œç”Ÿæˆï¼Œå½¢æˆå…©å€‹ç¨ç«‹çš„å­ç´°èƒã€‚"
            ];
            info.textContent = txt[state.step];
        } else if (state.mode === 'meiosis') {
            bMei.className += ' active-meiosis';
            const txt = [
                "é–“æœŸï¼šæŸ“è‰²é«”æœªè¤‡è£½ã€‚",
                "è¤‡è£½ï¼šæŸ“è‰²é«”è¤‡è£½å½¢æˆ X å‹ã€‚",
                "è¯æœƒï¼šåŒæºæŸ“è‰²é«”é…å° (å››åˆ†é«”)ã€‚",
                "ç¬¬ä¸€éšæ®µåˆ†é›¢ï¼šåŒæºæŸ“è‰²é«” (æ•´é¡†X) å·¦å³åˆ†é–‹ã€‚",
                "ç¬¬ä¸€éšæ®µå®Œæˆï¼šå½¢æˆå…©å€‹å­ç´°èƒ (æº–å‚™ä¸Šä¸‹åˆ†è£‚)ã€‚",
                "ç¬¬äºŒéšæ®µåˆ†é›¢ï¼šå·¦é‚Šç´°èƒæ··åˆåˆ†é… (å¯¦è™›åˆ†é›¢)ï¼Œå³é‚Šç¶­æŒè¦å‰‡åˆ†é…ã€‚",
                "å®Œæˆï¼šå½¢æˆ 4 å€‹å­ç´°èƒ (é…å­)ï¼Œè«‹è§€å¯ŸåŸºå› çµ„åˆçš„å·®ç•°ã€‚"
            ];
            info.textContent = txt[state.step];
        } else {
            bClo.className += ' active-cloning';
            const txt = [
                "è§’è‰²ä»‹ç´¹ï¼šAç¾Šç‚ºé»‘é¢æ¯ç¾Š(ä¾›æ ¸)ï¼ŒBç¾Šç‚ºç™½é¢æ¯ç¾Š(ä¾›åµ)ã€‚",
                "ç´°èƒæå–ï¼šå–å‡º Aç¾Šçš„é«”ç´°èƒ(2N)ï¼Œä»¥åŠ Bç¾Šçš„åµç´°èƒ(N)ã€‚",
                "å»æ ¸ï¼šå°‡ Bç¾Šåµç´°èƒçš„ç´°èƒæ ¸ç§»é™¤ï¼Œä¿ç•™ç´°èƒè³ªèˆ‡ç‡Ÿé¤Šã€‚",
                "èåˆï¼šå°‡ Aç¾Šçš„ç´°èƒæ ¸æ¤å…¥ Bç¾Šçš„å»æ ¸åµä¸­ï¼Œæ–½ä»¥é›»æ“Šèåˆã€‚",
                "ç™¼è‚²ï¼šèåˆç´°èƒé–‹å§‹åˆ†è£‚ï¼Œç™¼è‚²æˆå¤šç´°èƒçš„ã€Œæ¡‘æ¤¹èƒš/å›Šèƒšã€ã€‚",
                "æ¤å…¥ï¼šå°‡èƒšèƒæ¤å…¥ Cç¾Š(ä»£ç†å­•æ¯) çš„å­å®®å…§ã€‚",
                "èª•ç”Ÿï¼šCç¾Šç”¢ä¸‹å°ç¾Šã€‚å› ç‚ºç´°èƒæ ¸ä¾†è‡ªé»‘é¢ Aç¾Šï¼Œæ‰€ä»¥å°ç¾Šä¹Ÿæ˜¯é»‘é¢çš„ï¼"
            ];
            info.textContent = txt[state.step];
        }
    }

    function setMode(m) {
        state.mode = m;
        state.step = 0;
        updateScene();
        updateUI();
    }

    function changeStep(d) {
        const next = state.step + d;
        if (next >= 0 && next <= state.maxStep) {
            state.step = next;
            updateScene();
            updateUI();
        }
    }

</script>
</body>
</html>