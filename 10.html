<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>平面鏡成像 (雙人偶切換版)</title>
    <style>
        body { background: #1a1a1a; margin: 0; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        canvas { display: block; margin: 0 auto; background: #222; }
        
        /* UI 面板 */
        #instructions {
            position: absolute; 
            top: 20px; right: 20px; width: 300px; 
            color: #fff; background: rgba(50, 50, 50, 0.95); 
            padding: 15px 20px; border-radius: 12px; border: 1px solid #666;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 10; user-select: none;
            max-height: 90vh; overflow-y: auto;
        }

        /* 捲軸樣式 */
        #instructions::-webkit-scrollbar { width: 6px; }
        #instructions::-webkit-scrollbar-track { background: #333; }
        #instructions::-webkit-scrollbar-thumb { background: #666; border-radius: 3px; }

        h2 { margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 2px solid #44ffaa; padding-bottom: 8px; text-align: center; }
        p { margin: 5px 0; font-size: 0.9rem; color: #ccc; }

        /* 控制區塊 */
        .control-section { margin-top: 12px; border: 1px solid #555; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.2); transition: opacity 0.3s; }
        .control-title { font-weight: bold; font-size: 0.95rem; margin-bottom: 8px; color: #fff; border-bottom: 1px dashed #555; padding-bottom: 4px;}
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .input-row label { font-size: 0.85rem; color: #ddd; }
        .input-row input[type=number] { width: 55px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; padding: 1px 4px; font-size: 0.85rem;}
        input[type=range] { width: 100%; margin: 2px 0 8px 0; cursor: pointer; height: 6px; }

        /* 新增：切換按鈕樣式 */
        .toggle-box {
            margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #555;
            display: flex; align-items: center; justify-content: space-between;
        }
        .toggle-label { cursor: pointer; display: flex; align-items: center; font-size: 0.95rem; font-weight: bold; color: #88ccff; }
        .toggle-label input { margin-right: 8px; width: 16px; height: 16px; cursor: pointer; }

        #author { margin-top: 15px; text-align: right; font-size: 0.8rem; color: #888; font-style: italic; }
        .highlight { color: #ff6666; font-weight: bold; }
        
        /* 圖例 */
        .legend { font-size: 0.8rem; margin-top: 10px; border-top: 1px solid #555; padding-top: 8px; line-height: 1.6; }
        .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
        .legend-group { margin-bottom: 6px; }
        .legend-title { font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="err-log" style="position:absolute; top:0; left:0; color:red; background:rgba(0,0,0,0.8); z-index:99; display:none; padding:10px;"></div>

    <div id="instructions">
        <h2>平面鏡成像實驗</h2>
        
        <div class="toggle-box">
            <span>顯示人偶:</span>
            <label class="toggle-label">
                <input type="checkbox" id="chk-show-b" checked>
                顯示人偶 B
            </label>
        </div>

        <p>可拖曳並調整人偶參數。</p>
        
        <div class="control-section" style="border-left: 3px solid #ffddaa;">
            <div class="control-title" style="color:#ffddaa;">人偶 A (高個/紅球)</div>
            <div class="input-row">
                <label>身高 (H):</label><input type="number" id="num-h1" value="240" min="100" max="350">
            </div>
            <input type="range" id="rng-h1" value="240" min="100" max="350">
            <div class="input-row">
                <label>眼高 (E):</label><input type="number" id="num-e1" value="220" min="50" max="340">
            </div>
            <input type="range" id="rng-e1" value="220" min="50" max="340">
        </div>

        <div id="ctrl-b" class="control-section" style="border-left: 3px solid #88ccff;">
            <div class="control-title" style="color:#88ccff;">人偶 B (矮個/藍帽)</div>
            <div class="input-row">
                <label>身高 (H):</label><input type="number" id="num-h2" value="180" min="100" max="350">
            </div>
            <input type="range" id="rng-h2" value="180" min="100" max="350">
            <div class="input-row">
                <label>眼高 (E):</label><input type="number" id="num-e2" value="160" min="50" max="340">
            </div>
            <input type="range" id="rng-e2" value="160" min="50" max="340">
        </div>

        <div class="legend">
            <div class="legend-group">
                <span class="legend-title" style="color:#ffddaa">A光路:</span>
                <span class="dot" style="background:#ffdd00;"></span>頭 <span id="val-top1">--</span>
                <span class="dot" style="background:#00ff00; margin-left:8px;"></span>腳 <span id="val-btm1">--</span>
                (差 <span id="val-diff1" style="font-weight:bold">--</span>)
            </div>
            <div id="legend-b" class="legend-group">
                <span class="legend-title" style="color:#88ccff">B光路:</span>
                <span class="dot" style="background:#ff8800;"></span>頭 <span id="val-top2">--</span>
                <span class="dot" style="background:#00ccff; margin-left:8px;"></span>腳 <span id="val-btm2">--</span>
                (差 <span id="val-diff2" style="font-weight:bold">--</span>)
            </div>
        </div>

        <div id="author">小粘製作</div>
    </div>

    <canvas id="myCanvas"></canvas>

    <script>
        window.onerror = function(msg) {
            var el = document.getElementById("err-log");
            el.style.display = "block";
            el.innerHTML += "Error: " + msg + "<br>";
        };

        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        var w, h, cx, cy;

        // --- 全域變數 ---
        var showDollB = true; // 控制變數

        // --- 資料結構 ---
        var dolls = [
            { 
                id: 1, x: -200, h: 240, eye: 220, headR: 25, 
                dragging: false, offset: 0,
                style: { body: "#ffddaa", shirt: "#fff", prop: "ball_red", hat: false },
                colors: { headRay: "#ffdd00", footRay: "#00ff00" } 
            },
            { 
                id: 2, x: -350, h: 180, eye: 160, headR: 20, 
                dragging: false, offset: 0,
                style: { body: "#ffccaa", shirt: "#88ccff", prop: "cube_blue", hat: true },
                colors: { headRay: "#ff8800", footRay: "#00ccff" } 
            }
        ];

        var DRAG_TOLERANCE = 80;

        // --- 初始化 ---
        function init() {
            window.addEventListener("resize", resize);
            resize();
            setupInputs(dolls[0]);
            setupInputs(dolls[1]);
            setupToggle(); // 初始化切換按鈕
        }

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            cx = w / 2;
            cy = h / 2 + 180;
            loop();
        }

        // --- 切換按鈕邏輯 ---
        function setupToggle() {
            var chk = document.getElementById("chk-show-b");
            var ctrlB = document.getElementById("ctrl-b");
            var legendB = document.getElementById("legend-b");

            chk.addEventListener("change", function(e) {
                showDollB = e.target.checked;
                // UI 隱藏/顯示
                ctrlB.style.display = showDollB ? "block" : "none";
                legendB.style.display = showDollB ? "block" : "none";
                loop(); // 重繪畫布
            });
        }

        // --- 輸入控制 ---
        function setupInputs(doll) {
            var id = doll.id;
            var numH = document.getElementById("num-h" + id);
            var rngH = document.getElementById("rng-h" + id);
            var numE = document.getElementById("num-e" + id);
            var rngE = document.getElementById("rng-e" + id);

            function updateHeight(val) {
                doll.h = parseInt(val);
                numH.value = rngH.value = doll.h;
                if (doll.eye > doll.h - 5) {
                    doll.eye = doll.h - 5;
                    numE.value = rngE.value = doll.eye;
                }
                rngE.max = doll.h - 5; 
                numE.max = doll.h - 5;
                loop();
            }

            function updateEye(val) {
                doll.eye = parseInt(val);
                numE.value = rngE.value = doll.eye;
                loop();
            }

            numH.oninput = function() { updateHeight(this.value); };
            rngH.oninput = function() { updateHeight(this.value); };
            numE.oninput = function() { updateEye(this.value); };
            rngE.oninput = function() { updateEye(this.value); };
        }
        
        // --- 滑鼠事件 ---
        function onMouseDown(e) {
            var rect = canvas.getBoundingClientRect();
            var mx = e.clientX - rect.left - cx;
            var my = e.clientY - rect.top - cy;

            for (var i = dolls.length - 1; i >= 0; i--) {
                var d = dolls[i];
                // 如果人偶是 ID 2 (B) 且設定為不顯示，則跳過檢測
                if (d.id === 2 && !showDollB) continue;

                if (Math.abs(mx - d.x) < DRAG_TOLERANCE && my > -d.h - 50 && my < 50) {
                    d.dragging = true;
                    d.offset = mx - d.x;
                    document.body.style.cursor = "grabbing";
                    return; 
                }
            }
        }

        function onMouseMove(e) {
            var rect = canvas.getBoundingClientRect();
            var mx = e.clientX - rect.left - cx;
            var my = e.clientY - rect.top - cy;
            
            var anyDragging = false;
            for(var i=0; i<dolls.length; i++) {
                var d = dolls[i];
                // 如果在拖曳中，即使隱藏了邏輯上也不會斷開，但顯示上已過濾
                if (d.dragging) {
                    var newX = mx - d.offset;
                    if (newX > -35) newX = -35; 
                    if (newX < -w/2 + 80) newX = -w/2 + 80;
                    d.x = newX;
                    anyDragging = true;
                }
            }

            if (anyDragging) {
                loop();
            } else {
                var hovering = false;
                for(var i=0; i<dolls.length; i++) {
                    var d = dolls[i];
                    if (d.id === 2 && !showDollB) continue; // 略過隱藏的人偶

                    if (Math.abs(mx - d.x) < DRAG_TOLERANCE && my > -d.h - 50 && my < 50) {
                        hovering = true;
                    }
                }
                document.body.style.cursor = hovering ? "grab" : "default";
            }
        }

        function onMouseUp() {
            for(var i=0; i<dolls.length; i++) dolls[i].dragging = false;
            document.body.style.cursor = "default";
        }
        
        canvas.addEventListener("mousedown", onMouseDown);
        window.addEventListener("mousemove", onMouseMove);
        window.addEventListener("mouseup", onMouseUp);

        // --- 繪圖主循環 ---
        function loop() {
            try {
                ctx.fillStyle = "#1a1a1a";
                ctx.fillRect(0, 0, w, h);
                
                ctx.save();
                ctx.translate(cx, cy);

                drawFloor();
                drawMirror();

                // 1. 虛像
                ctx.save();
                ctx.scale(-1, 1); 
                for(var i=0; i<dolls.length; i++) {
                    // 判斷顯示開關
                    if (dolls[i].id === 2 && !showDollB) continue;
                    drawHuman(dolls[i], 0.4);
                }
                ctx.restore();

                // 2. 光路與標記 (先畫B再畫A)
                // 只有當顯示 B 時才畫 B
                if (showDollB) drawRaysAndMarkers(dolls[1]);
                drawRaysAndMarkers(dolls[0]);

                // 3. 實物
                for(var i=0; i<dolls.length; i++) {
                    if (dolls[i].id === 2 && !showDollB) continue;
                    drawHuman(dolls[i], 1.0);
                }

                ctx.restore();
            } catch(e) {
                console.error(e);
            }
        }

        // --- 繪圖組件 ---

        function drawFloor() {
            ctx.strokeStyle = "#444"; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(-w/2, 0); ctx.lineTo(w/2, 0); ctx.stroke();
            ctx.save(); ctx.beginPath();
            for (let i = -w; i < w; i+=100) {
                ctx.moveTo(i, 0); ctx.lineTo((i - 0) * 3, 500);
            }
            ctx.globalAlpha = 0.2; ctx.stroke(); ctx.restore();
        }

        function drawMirror() {
            ctx.fillStyle = "rgba(200, 255, 255, 0.1)";
            ctx.fillRect(-5, -550, 10, 600); 
            ctx.beginPath(); ctx.moveTo(0, -550); ctx.lineTo(0, 50);
            ctx.strokeStyle = "#44ffaa"; ctx.lineWidth = 4; ctx.stroke();
            ctx.beginPath(); ctx.strokeStyle = "#666"; ctx.lineWidth = 2;
            for(let y = -540; y < 0; y+=25) {
                ctx.moveTo(0, y); ctx.lineTo(15, y+15);
            }
            ctx.stroke();
        }

        function drawHuman(doll, opacity) {
            ctx.save();
            ctx.globalAlpha = opacity;
            ctx.translate(doll.x, 0);

            var h = doll.h;
            var headR = doll.headR;
            var eyeY = doll.eye;
            var style = doll.style;
            
            var bodyColor = opacity === 1 ? style.body : "#88ccff";
            var shirtColor = opacity === 1 ? style.shirt : "#88ccff";
            
            // 頭
            ctx.fillStyle = bodyColor;
            ctx.beginPath(); 
            var headCenterY = -h + headR;
            ctx.arc(0, headCenterY, headR, 0, Math.PI*2); 
            ctx.fill();

            // 帽子
            if (style.hat && opacity === 1) {
                ctx.fillStyle = "#4466cc"; 
                ctx.beginPath();
                ctx.moveTo(-headR-5, -h + headR/2);
                ctx.lineTo(headR+5, -h + headR/2);
                ctx.lineTo(headR, -h - headR/2);
                ctx.lineTo(-headR, -h - headR/2);
                ctx.fill();
            }

            // 眼睛
            var actualEyeY = -eyeY;
            ctx.fillStyle = opacity === 1 ? "#000" : "rgba(0,0,0,0.5)";
            ctx.beginPath();
            ctx.arc(headR/2.5, actualEyeY, 3, 0, Math.PI*2); 
            ctx.fill();

            // 身體
            ctx.strokeStyle = shirtColor; ctx.lineWidth = headR/3;
            ctx.beginPath();
            ctx.moveTo(0, -h + headR * 2); ctx.lineTo(0, -h/2); ctx.stroke();

            // 腳
            ctx.strokeStyle = "#888"; ctx.lineWidth = headR/4;
            ctx.beginPath();
            ctx.moveTo(0, -h/2); ctx.lineTo(-headR+5, 0); 
            ctx.moveTo(0, -h/2); ctx.lineTo(headR-5, 0);  
            ctx.stroke();

            // 手
            ctx.strokeStyle = bodyColor; ctx.lineWidth = headR/4;
            ctx.beginPath();
            var shoulderY = -h + headR * 2 + 5;
            ctx.moveTo(0, shoulderY); ctx.lineTo(-headR-10, -h/2 - 20); ctx.stroke();
            
            var handRaiseY = -eyeY + 20;
            ctx.beginPath();
            ctx.moveTo(0, shoulderY); ctx.lineTo(headR+10, handRaiseY); ctx.stroke();

            // 道具
            if (style.prop === "ball_red") {
                ctx.fillStyle = "#ff4444";
                ctx.beginPath(); ctx.arc(headR+15, handRaiseY, 10, 0, Math.PI*2); ctx.fill();
            } else if (style.prop === "cube_blue") {
                ctx.fillStyle = "#4488ff";
                ctx.fillRect(headR+5, handRaiseY-10, 20, 20);
            }

            // 陰影
            if (opacity === 1) {
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.beginPath(); ctx.ellipse(0, 0, headR+5, 8, 0, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }

        function drawRaysAndMarkers(doll) {
            var ox = doll.x;
            var headY = -doll.h;
            var eyeY = -doll.eye;
            var footY = 0;
            var colors = doll.colors;
            var id = doll.id;

            var refHeadY = (headY + eyeY) / 2;
            var refFootY = (footY + eyeY) / 2;
            var diff = Math.abs(refHeadY - refFootY);

            // 更新 UI
            var elTop = document.getElementById("val-top" + id);
            var elBtm = document.getElementById("val-btm" + id);
            var elDiff = document.getElementById("val-diff" + id);
            if(elTop) elTop.innerText = Math.abs(refHeadY).toFixed(0);
            if(elBtm) elBtm.innerText = Math.abs(refFootY).toFixed(0);
            if(elDiff) elDiff.innerText = diff.toFixed(0);

            var textSide = id === 1 ? "right" : "left"; 
            drawMarker(refHeadY, colors.headRay, textSide);
            drawMarker(refFootY, colors.footRay, textSide);

            ctx.lineWidth = 2;
            ctx.strokeStyle = colors.headRay; ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(ox, headY); ctx.lineTo(0, refHeadY); ctx.lineTo(ox, eyeY); ctx.stroke();
            ctx.strokeStyle = fadeColor(colors.headRay); ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(0, refHeadY); ctx.lineTo(-ox, headY); ctx.stroke();

            ctx.strokeStyle = colors.footRay; ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(ox, footY); ctx.lineTo(0, refFootY); ctx.lineTo(ox, eyeY); ctx.stroke();
            ctx.strokeStyle = fadeColor(colors.footRay); ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(0, refFootY); ctx.lineTo(-ox, footY); ctx.stroke();
        }

        function drawMarker(y, color, side) {
            ctx.fillStyle = color;
            ctx.beginPath(); ctx.arc(0, y, 4, 0, Math.PI*2); ctx.fill();
            
            ctx.save();
            ctx.fillStyle = color;
            ctx.font = "bold 12px Arial";
            ctx.textBaseline = "middle";
            if (side === "right") {
                ctx.textAlign = "left";
                ctx.fillText(Math.abs(y).toFixed(0), 10, y);
            } else {
                ctx.textAlign = "right";
                ctx.fillText(Math.abs(y).toFixed(0), -10, y);
            }
            ctx.restore();
        }

        function fadeColor(hex) {
            if (hex.startsWith("#") && hex.length === 7) {
                var r = parseInt(hex.slice(1, 3), 16);
                var g = parseInt(hex.slice(3, 5), 16);
                var b = parseInt(hex.slice(5, 7), 16);
                return "rgba(" + r + "," + g + "," + b + ", 0.4)";
            }
            return hex;
        }

        init();
    </script>
</body>
</html>