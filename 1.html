<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›¢å­åŒ–åˆç‰©é…å°ç·´ç¿’</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --bg-color: #f4f6f7;
            --header-bg: #e8f6f3;
            --border-color: #bdc3c7;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- é ‚éƒ¨å€åŸŸ --- */
        .top-section {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            flex-shrink: 0;
            padding-bottom: 10px;
        }

        .header-title { padding: 10px 10px 5px 10px; }

        h1 {
            color: var(--primary-color);
            margin: 0 0 5px 0;
            font-size: 1.2rem;
        }
        
        .subtitle { color: #7f8c8d; font-size: 0.8rem; }

        /* åˆ†é æŒ‰éˆ• */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
            padding: 0 10px;
        }

        .tab-btn {
            padding: 6px 16px;
            border: 2px solid var(--accent-color);
            background: transparent;
            color: var(--accent-color);
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: white;
        }

        /* --- è¦–åœ–å®¹å™¨ --- */
        .view-container {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg-color);
        }

        .view-section {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        
        .view-section.active-view { display: flex; }

        /* --- è¡¨æ ¼æ¨¡å¼æ¨£å¼ --- */
        .table-scroll-area {
            flex-grow: 1;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            background: #fff;
        }

        .table-controls {
            padding: 10px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        table { border-collapse: separate; border-spacing: 0; margin: 0 auto; }

        th, td {
            border: 1px solid var(--border-color);
            padding: 4px;
            text-align: center;
            vertical-align: middle;
            min-width: 105px;
            height: 70px;
        }

        th {
            background-color: #ecf0f1;
            color: var(--primary-color);
            font-weight: bold;
            white-space: nowrap;
        }

        /* Sticky Headers */
        th.corner-header { position: sticky; left: 0; top: 0; z-index: 30; background: #fff; border-right: 2px solid var(--border-color); border-bottom: 2px solid var(--border-color); }
        th.col-header { position: sticky; top: 0; z-index: 20; background: var(--header-bg); border-bottom: 2px solid var(--border-color); }
        th.row-header { position: sticky; left: 0; z-index: 20; background: var(--header-bg); border-right: 2px solid var(--border-color); }

        /* --- æ¸¬é©—æ¨¡å¼æ¨£å¼ --- */
        .quiz-config-panel {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            background: #f0f2f5;
            padding: 5px;
            border-radius: 20px;
        }

        .radio-label {
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #7f8c8d;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-label input { display: none; }
        
        .radio-label.checked {
            background: white;
            color: var(--accent-color);
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .quiz-btn-group {
            display: flex;
            gap: 10px;
        }

        .quiz-scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        /* æ©«å¼é¡Œå‹å¡ç‰‡è¨­è¨ˆ */
        .quiz-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            animation: fadeIn 0.4s ease-out;
            
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* === é—œéµä¿®æ”¹ï¼šé¡Œç›®é¡¯ç¤ºå€åŸŸ === 
           åŠ å¼·äº†å­—é«”å¤§å°å’ŒåŒ–å­¸å¼çš„æ’ç‰ˆ
        */
        .quiz-question-part {
            display: flex;
            align-items: center;
            font-size: 1.5rem; /* å­—é«”æ”¾å¤§ */
            font-family: "Times New Roman", Times, serif;
            color: var(--primary-color);
            flex-grow: 1;
            min-width: 120px;
            line-height: 1.8; /* å¢åŠ è¡Œé«˜ï¼Œé¿å…ä¸Šæ¨™è¢«åˆ‡æ‰ */
            letter-spacing: 1px; /* å¢åŠ å­—è·ï¼Œé¿å…æ•¸å­—å¤ªæ“  */
        }

        /* === é—œéµä¿®æ”¹ï¼šä¸Šæ¨™èˆ‡ä¸‹æ¨™çš„ç²¾æº–å®šä½ === 
           è®“ sup é£›é«˜ä¸€é»ï¼Œsub æ²‰ä½ä¸€é»ï¼Œä¸¦ç¸®å°å­—é«”
        */
        .quiz-question-part sup {
            font-size: 0.6em;       /* ç¸®å°é›»è·æ•¸å­— */
            vertical-align: baseline; 
            position: relative;
            top: -0.6em;            /* æ˜é¡¯å‘ä¸Šæ‹‰ */
            margin-left: 1px;       /* èˆ‡å­—æ¯ç¨å¾®åˆ†é–‹ */
            font-weight: bold;      /* ç¨å¾®åŠ ç²—æ›´æ¸…æ™° */
        }

        .quiz-question-part sub {
            font-size: 0.6em;
            vertical-align: baseline;
            position: relative;
            bottom: -0.25em;        /* æ˜é¡¯å‘ä¸‹æ‹‰ */
            margin-left: 0px;
            color: #555;            /* åŸå­å€‹æ•¸é¡è‰²ç¨å¾®æ·¡ä¸€é»é»ï¼Œå€åˆ†å±¤æ¬¡ */
        }

        .q-index {
            font-size: 0.8rem;
            color: #bdc3c7;
            margin-right: 12px;
            font-weight: normal;
            font-family: sans-serif;
            min-width: 25px;
            letter-spacing: 0;
        }

        /* è¼¸å…¥éƒ¨åˆ† (å³å´) */
        .quiz-input-part {
            flex-grow: 1;
            min-width: 140px;
            position: relative;
        }

        .quiz-input {
            width: 100%;
            height: 42px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1.1rem;
            text-align: center;
            background: #fafafa;
        }

        .arrow-icon {
            margin: 0 10px;
            color: #95a5a6;
            font-size: 1.2rem;
            position: relative;
            top: -2px; /* å¾®èª¿ç®­é ­å‚ç›´ç½®ä¸­ */
        }

        /* åé¥‹è¨Šæ¯ */
        .quiz-feedback {
            width: 100%;
            font-size: 0.9rem;
            text-align: right;
            margin-top: 5px;
            display: none;
        }
        
        .quiz-card.checked .quiz-feedback { display: block; }

        /* é€šç”¨å…ƒä»¶ */
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            touch-action: manipulation;
        }
        button:active { transform: scale(0.95); }
        button.check-btn { background-color: var(--success-color); }
        button.reset-btn { background-color: #95a5a6; }

        input:focus { border-color: var(--accent-color); outline: none; background: #fff; }
        
        .correct .quiz-input { background-color: #d4edda; border-color: #28a745; color: #155724; font-weight: bold; }
        .incorrect .quiz-input { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        
        .answer-reveal {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            color: #27ae60;
            font-weight: bold;
            display: none;
            background: rgba(255,255,255,0.9);
            padding: 2px 5px;
        }
        
        .show-answers .answer-reveal { display: block; }
        .show-answers input { color: transparent; }

        .creator-badge {
            font-size: 0.75rem;
            color: #95a5a6;
            background: #eee;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* è¡¨æ ¼å…§çš„ä¸€èˆ¬ sup/sub ç¶­æŒåŸæ¨£ï¼Œé¿å…æŠŠè¡¨æ ¼æ’å¤ªé«˜ */
        table sup { font-size: 0.75em; vertical-align: super; }
        table sub { font-size: 0.75em; vertical-align: sub; }
        #chemistryTable input { height: 34px; font-size: 16px; width: 95%; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="top-section">
        <div class="header-title">
            <h1>é›¢å­åŒ–åˆç‰©é…å°</h1>
            <span class="subtitle">å°ç²˜è£½ä½œ</span>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchView('table')">è¡¨æ ¼ç·´ç¿’</button>
            <button class="tab-btn" onclick="switchView('quiz')">éš¨æ©Ÿæ¸¬é©—</button>
        </div>
    </div>

    <div class="view-container">
        
        <div id="view-table" class="view-section active-view">
            <div class="table-controls">
                <button class="check-btn" onclick="checkTableAnswers()">æª¢æŸ¥</button>
                <button class="reset-btn" onclick="resetTable()">é‡ç½®</button>
                <button onclick="toggleTableMode()">è§£ç­”</button>
            </div>
            <div class="table-scroll-area">
                <table id="chemistryTable"></table>
                <div style="height: 50px;"></div>
            </div>
        </div>

        <div id="view-quiz" class="view-section">
            <div class="quiz-config-panel">
                <div class="radio-group">
                    <label class="radio-label checked" onclick="setQuizType('ions', this)">
                        <input type="radio" name="qType" value="ions" checked> é›¢å­çµ„åˆ
                    </label>
                    <label class="radio-label" onclick="setQuizType('name', this)">
                        <input type="radio" name="qType" value="name"> ä¸­æ–‡åç¨±
                    </label>
                </div>

                <div class="quiz-btn-group">
                    <button class="quiz-mode-btn" onclick="startQuiz(3)">ğŸ² 3 é¡Œ</button>
                    <button class="quiz-mode-btn" onclick="startQuiz(5)">ğŸ² 5 é¡Œ</button>
                </div>
            </div>
            
            <div id="quiz-area" class="quiz-scroll-area">
                <div style="text-align: center; margin-top: 50px; color: #95a5a6;">
                    è«‹é¸æ“‡é¡Œå‹ä¸¦é–‹å§‹æ¸¬é©—
                </div>
            </div>

            <div id="quiz-actions" class="table-controls" style="display:none; border-top: 1px solid #eee;">
                <button class="check-btn" onclick="checkQuizAnswers()">äº¤å·</button>
                <button onclick="toggleQuizAnswers()">è§£ç­”</button>
            </div>
        </div>

    </div>

    <script>
        // --- è³‡æ–™è¨­å®š ---
        const cations = [
            { id: 'H', label: 'H<sup>+</sup>', charge: 1, name: 'æ°«' },
            { id: 'Na', label: 'Na<sup>+</sup>', charge: 1, name: 'éˆ‰' },
            { id: 'K', label: 'K<sup>+</sup>', charge: 1, name: 'é‰€' },
            { id: 'Ca', label: 'Ca<sup>2+</sup>', charge: 2, name: 'éˆ£' },
            { id: 'Mg', label: 'Mg<sup>2+</sup>', charge: 2, name: 'é‚' },
            { id: 'Cu', label: 'Cu<sup>2+</sup>', charge: 2, name: 'éŠ…' },
            { id: 'Fe', label: 'Fe<sup>3+</sup>', charge: 3, name: 'éµ' },
            { id: 'NH4', label: 'NH<sub>4</sub><sup>+</sup>', charge: 1, name: 'éŠ¨', poly: true }
        ];

        const anions = [
            { id: 'Cl', label: 'Cl<sup>-</sup>', charge: 1, name: 'æ°¯', suffix: 'åŒ–' },
            { id: 'O', label: 'O<sup>2-</sup>', charge: 2, name: 'æ°§', suffix: 'åŒ–' },
            { id: 'OH', label: 'OH<sup>-</sup>', charge: 1, name: 'æ°«æ°§', suffix: 'åŒ–', poly: true },
            { id: 'NO3', label: 'NO<sub>3</sub><sup>-</sup>', charge: 1, name: 'ç¡é…¸', suffix: '', poly: true },
            { id: 'CH3COO', label: 'CH<sub>3</sub>COO<sup>-</sup>', charge: 1, name: 'é†‹é…¸', suffix: '', poly: true },
            { id: 'CO3', label: 'CO<sub>3</sub><sup>2-</sup>', charge: 2, name: 'ç¢³é…¸', suffix: '', poly: true },
            { id: 'SO4', label: 'SO<sub>4</sub><sup>2-</sup>', charge: 2, name: 'ç¡«é…¸', suffix: '', poly: true },
            { id: 'PO4', label: 'PO<sub>4</sub><sup>3-</sup>', charge: 3, name: 'ç£·é…¸', suffix: '', poly: true }
        ];

        const blockedCells = ['NH4_O']; 
        
        const acids = {
            'H_Cl': { formula: 'HCl', name: 'é¹½é…¸' },
            'H_NO3': { formula: 'HNO3', name: 'ç¡é…¸' },
            'H_SO4': { formula: 'H2SO4', name: 'ç¡«é…¸' },
            'H_CO3': { formula: 'H2CO3', name: 'ç¢³é…¸' },
            'H_CH3COO': { formula: 'CH3COOH', name: 'é†‹é…¸' },
            'H_OH': { formula: 'H2O', name: 'æ°´' },
            'H_O': { formula: 'H2O', name: 'æ°´' },
            'H_PO4': { formula: 'H3PO4', name: 'ç£·é…¸' }
        };

        let currentQuizType = 'ions'; 

        // --- åˆå§‹åŒ–èˆ‡è¡¨æ ¼é‚è¼¯ ---
        function initTable() {
            const table = document.getElementById('chemistryTable');
            let headerRow = '<thead><tr><th class="corner-header"></th>';
            cations.forEach(cat => headerRow += `<th class="col-header">${cat.label}</th>`);
            headerRow += '</tr></thead><tbody>';

            anions.forEach(anion => {
                let row = `<tr><th class="row-header">${anion.label}</th>`;
                cations.forEach(cation => {
                    const cellId = `${cation.id}_${anion.id}`;
                    if (blockedCells.includes(cellId)) {
                        row += `<td class="blocked"></td>`;
                    } else {
                        const answer = calculateAnswer(cation, anion);
                        row += `
                            <td class="cell" data-formula="${answer.formula}" data-name="${answer.name}">
                                <div class="cell-content">
                                    <input type="text" autocomplete="off" autocapitalize="off" autocorrect="off">
                                    <div class="answer-reveal">
                                        <div>${formatFormula(answer.formula)}</div>
                                        <div style="font-size:0.75em; color:#7f8c8d;">${answer.name}</div>
                                    </div>
                                </div>
                            </td>`;
                    }
                });
                row += '</tr>';
                headerRow += row;
            });
            headerRow += '</tbody>';
            table.innerHTML = headerRow;
        }

        function calculateAnswer(cat, an) {
            const acidKey = `${cat.id}_${an.id}`;
            if (acids[acidKey]) return acids[acidKey];

            let cCharge = cat.charge;
            let aCharge = an.charge;
            const commonDivisor = gcd(cCharge, aCharge);
            const numCat = aCharge / commonDivisor;
            const numAn = cCharge / commonDivisor;

            let formula = "";
            if (an.id === 'CH3COO') {
                formula = 'CH3COO';
                if (numAn > 1) formula = `(${formula})${numAn}`; 
                formula += cat.id;
                if (numCat > 1) formula += numCat;
            } else {
                formula = cat.id;
                if (cat.poly && numCat > 1) formula = `(${formula})`;
                if (numCat > 1) formula += numCat;

                let partAn = an.id;
                if (an.poly && numAn > 1) partAn = `(${partAn})`;
                formula += partAn;
                if (numAn > 1) formula += numAn;
            }

            let name = an.name + an.suffix + cat.name;
            return { formula, name };
        }

        function gcd(a, b) { return !b ? a : gcd(b, a % b); }
        function formatFormula(str) { return str.replace(/(\d+)/g, '<sub>$1</sub>'); }

        // --- ä»‹é¢æ§åˆ¶ ---
        function switchView(mode) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active-view'));
            document.getElementById(`view-${mode}`).classList.add('active-view');
        }

        function setQuizType(type, element) {
            currentQuizType = type;
            document.querySelectorAll('.radio-label').forEach(el => el.classList.remove('checked'));
            element.classList.add('checked');
            document.getElementById('quiz-area').innerHTML = '<div style="text-align: center; margin-top: 50px; color: #95a5a6;">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ–°é¡Œå‹æ¸¬é©—</div>';
            document.getElementById('quiz-actions').style.display = 'none';
        }

        // --- è¡¨æ ¼æ¨¡å¼åŠŸèƒ½ ---
        function checkTableAnswers() {
            document.querySelectorAll('#view-table input').forEach(input => {
                const cell = input.closest('td');
                const val = input.value.trim();
                if(!val) { cell.classList.remove('correct','incorrect'); return; }
                
                let isCorrect = false;
                if(val.toLowerCase() === cell.dataset.formula.toLowerCase()) isCorrect = true;
                if(val === cell.dataset.name) isCorrect = true;
                if(val.toUpperCase() === cell.dataset.formula.toUpperCase()) isCorrect = true;

                cell.classList.toggle('correct', isCorrect);
                cell.classList.toggle('incorrect', !isCorrect);
            });
        }

        function resetTable() {
            document.querySelectorAll('#view-table input').forEach(i => {
                i.value = '';
                i.closest('td').classList.remove('correct', 'incorrect');
            });
            document.querySelector('.table-scroll-area').classList.remove('show-answers');
        }
        function toggleTableMode() {
            document.querySelector('.table-scroll-area').classList.toggle('show-answers');
        }

        // --- æ¸¬é©—æ¨¡å¼é‚è¼¯ ---
        function startQuiz(count) {
            const quizArea = document.getElementById('quiz-area');
            quizArea.innerHTML = '';
            quizArea.classList.remove('show-answers');
            
            let questions = [];
            let attempts = 0;
            
            while (questions.length < count && attempts < 1000) {
                attempts++;
                const catIdx = Math.floor(Math.random() * cations.length);
                const anIdx = Math.floor(Math.random() * anions.length);
                const cation = cations[catIdx];
                const anion = anions[anIdx];
                const cellId = `${cation.id}_${anion.id}`;

                if (blockedCells.includes(cellId)) continue;
                if (questions.some(q => q.id === cellId)) continue;
                questions.push({ cation, anion, id: cellId });
            }

            questions.forEach((q, index) => {
                const ans = calculateAnswer(q.cation, q.anion);
                const card = document.createElement('div');
                card.className = 'quiz-card';
                
                let questionHtml = '';
                let placeholder = '';
                
                if (currentQuizType === 'ions') {
                    // .label å±¬æ€§ä¸­å·²åŒ…å« <sup> æ¨™ç±¤ï¼Œé€é CSS æœƒé¡¯ç¤ºåœ¨å³ä¸Šè§’
                    questionHtml = `
                        <span class="q-index">${index+1}.</span>
                        ${q.cation.label} + ${q.anion.label}
                        <span class="arrow-icon">&rarr;</span>
                    `;
                    placeholder = 'å¯«åŒ–å­¸å¼';
                } else {
                    questionHtml = `
                        <span class="q-index">${index+1}.</span>
                        ${ans.name}
                        <span class="arrow-icon">=</span>
                    `;
                    placeholder = 'å¯«åŒ–å­¸å¼';
                }

                card.innerHTML = `
                    <div class="quiz-question-part">
                        ${questionHtml}
                    </div>
                    <div class="quiz-input-part" data-formula="${ans.formula}" data-name="${ans.name}">
                        <input type="text" class="quiz-input" placeholder="${placeholder}" autocomplete="off" autocapitalize="off" autocorrect="off">
                        <div class="answer-reveal">
                            ${formatFormula(ans.formula)}
                        </div>
                    </div>
                    <div class="quiz-feedback"></div>
                `;
                quizArea.appendChild(card);
            });

            document.getElementById('quiz-actions').style.display = 'flex';
        }

        function checkQuizAnswers() {
            document.querySelectorAll('.quiz-input').forEach(input => {
                const inputPart = input.parentElement;
                const card = inputPart.parentElement;
                const feedback = card.querySelector('.quiz-feedback');
                
                const formula = inputPart.dataset.formula;
                const name = inputPart.dataset.name;
                const val = input.value.trim();

                let isCorrect = false;
                
                if (currentQuizType === 'ions') {
                    if (val.toLowerCase() === formula.toLowerCase()) isCorrect = true;
                    if (val === name) isCorrect = true;
                    if (val.toUpperCase() === formula.toUpperCase()) isCorrect = true;
                } else {
                    if (val.toLowerCase() === formula.toLowerCase()) isCorrect = true;
                    if (val.toUpperCase() === formula.toUpperCase()) isCorrect = true;
                }

                card.classList.remove('correct', 'incorrect');
                card.classList.add('checked');
                
                if (val === "") {
                    feedback.textContent = "æœªä½œç­”";
                    feedback.style.color = "#95a5a6";
                } else if (isCorrect) {
                    card.classList.add('correct');
                    feedback.textContent = "æ­£ç¢ºï¼ğŸ‘";
                    feedback.style.color = "#27ae60";
                } else {
                    card.classList.add('incorrect');
                    // é€™è£¡ä½¿ç”¨ innerHTML ç¢ºä¿ "ç­”æ¡ˆæ˜¯..." çš„åŒ–å­¸å¼ä¹Ÿèƒ½æ­£ç¢ºé¡¯ç¤ºä¸‹æ¨™
                    feedback.innerHTML = `ç­”æ¡ˆæ˜¯ ${formatFormula(formula)}`; 
                    feedback.style.color = "#c0392b";
                }
            });
        }

        function toggleQuizAnswers() {
            document.getElementById('quiz-area').classList.toggle('show-answers');
        }

        window.onload = initTable;

    </script>
</body>
</html>